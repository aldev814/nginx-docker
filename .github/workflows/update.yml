name: Update Dependencies

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      nginx_version:
        description: 'Force Nginx Version (e.g. 1.29.4)'
        required: false
        type: string

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Check All Updates
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          UPDATED=false
          MSG=""
          
          # --- 辅助函数：获取 GitHub 最新 Release/Tag ---
          # 优先获取 Release (Latest)，没有则获取最新的 Tag
          get_gh_ver() {
            repo=$1
            # 尝试获取 Latest Release (通常是 Mainline)
            ver=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$repo/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
            
            # 如果没有 Release (有些 repo 只打 tag)，则获取最新 Tag
            if [ -z "$ver" ] || [ "$ver" == "null" ]; then
              ver=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$repo/tags" | grep '"name":' | head -1 | sed -E 's/.*"([^"]+)".*/\1/')
            fi
            
            # 清理版本号 (移除前缀 v, release-, release-release-)
            echo $ver | sed -E 's/^(v|release-|release-release-)//'
          }

          # --- 1. Nginx 更新检查 (使用官方 GitHub API) ---
          CUR_NGINX=$(grep "ARG NGINX_VERSION=" Dockerfile | cut -d= -f2)
          INPUT_NGINX="${{ inputs.nginx_version }}"
          
          if [ -n "$INPUT_NGINX" ]; then
            TARGET_NGINX="$INPUT_NGINX"
          else
            # 从 nginx/nginx 仓库获取最新 Mainline 版本
            TARGET_NGINX=$(get_gh_ver "nginx/nginx")
          fi
          
          # 安全检查：确保获取到的版本号格式正确 (x.x.x)
          if ! [[ "$TARGET_NGINX" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
             echo "Error: Detect invalid Nginx version: '$TARGET_NGINX'. skipping update."
             exit 1
          fi
          
          if [[ "$CUR_NGINX" != "$TARGET_NGINX" ]]; then
            sed -i "s/ARG NGINX_VERSION=.*/ARG NGINX_VERSION=$TARGET_NGINX/" Dockerfile
            UPDATED=true
            MSG="$MSG Nginx $TARGET_NGINX,"
            echo "nginx_changed=true" >> $GITHUB_OUTPUT
            echo "nginx_ver=$TARGET_NGINX" >> $GITHUB_OUTPUT
          else
            echo "nginx_changed=false" >> $GITHUB_OUTPUT
            echo "nginx_ver=$CUR_NGINX" >> $GITHUB_OUTPUT
          fi

          # --- 2. OpenSSL (3.4.x 系列) ---
          CUR_SSL=$(grep "ARG OPENSSL_VERSION=" Dockerfile | cut -d= -f2 | tr -d '"')
          # 继续使用 openssl 官网抓取，但增加 sort -V 确保排序
          NEW_SSL=$(curl -s https://www.openssl.org/source/ | grep -oP 'openssl-3\.4\.\d+' | sort -V | tail -1 | cut -d- -f2)
          if [[ -n "$NEW_SSL" && "$CUR_SSL" != "$NEW_SSL" ]]; then
             sed -i "s/ARG OPENSSL_VERSION=.*/ARG OPENSSL_VERSION=\"$NEW_SSL\"/" Dockerfile
             UPDATED=true
             MSG="$MSG OpenSSL $NEW_SSL,"
          fi

          # --- 3. 遍历 GitHub 模块 ---
          MODULES=(
            "JEMALLOC_VERSION|jemalloc/jemalloc"
            "HEADERS_MORE_VERSION|openresty/headers-more-nginx-module"
            "GEOIP2_VERSION|leev/ngx_http_geoip2_module"
            "LIBATOMIC_VERSION|ivmai/libatomic_ops"
            "FANCYINDEX_VERSION|aperezdc/ngx-fancyindex"
          )

          for mod in "${MODULES[@]}"; do
            ARG_NAME="${mod%%|*}"
            REPO="${mod##*|}"
            CUR_VAL=$(grep "ARG $ARG_NAME=" Dockerfile | cut -d= -f2 | tr -d '"')
            NEW_VAL=$(get_gh_ver "$REPO")
            
            if [[ -n "$NEW_VAL" && "$CUR_VAL" != "$NEW_VAL" ]]; then
              echo "Updating $ARG_NAME: $CUR_VAL -> $NEW_VAL"
              sed -i "s/ARG $ARG_NAME=.*/ARG $ARG_NAME=\"$NEW_VAL\"/" Dockerfile
              UPDATED=true
              MSG="$MSG ${REPO##*/} $NEW_VAL,"
            fi
          done

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "msg=${MSG%,}" >> $GITHUB_OUTPUT

      - name: Commit and Push
        if: steps.check.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Dockerfile
          git commit -m "chore: update dependencies (${{ steps.check.outputs.msg }})"
          git push origin main
          
          NGINX_VER="${{ steps.check.outputs.nginx_ver }}"
          if [ "${{ steps.check.outputs.nginx_changed }}" == "true" ]; then
            TAG_NAME="v$NGINX_VER"
          else
            TAG_NAME="v$NGINX_VER-upd$(date +%Y%m%d)"
          fi
          
          echo "Pushing tag: $TAG_NAME"
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"
